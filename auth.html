<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vladivostok - 注册/登录</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
    .container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; box-sizing: border-box; }
    button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #45a049; }
    .toggle-link { color: #0066cc; cursor: pointer; text-align: center; display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 注册表单 -->
    <div id="register-form">
      <h2>注册账号</h2>
      <div class="form-group">
        <label for="reg-nickname">昵称</label>
        <input type="text" id="reg-nickname" placeholder="请输入昵称（唯一）" required>
      </div>
      <div class="form-group">
        <label for="reg-password">密码</label>
        <input type="password" id="reg-password" placeholder="请输入密码" required>
      </div>
      <button onclick="register()">注册</button>
      <p class="toggle-link" onclick="toggleForm()">已有账号？点击登录</p>
    </div>

    <!-- 登录表单 -->
    <div id="login-form" style="display: none;">
      <h2>登录账号</h2>
      <div class="form-group">
        <label for="login-nickname">昵称</label>
        <input type="text" id="login-nickname" placeholder="请输入昵称" required>
      </div>
      <div class="form-group">
        <label for="login-password">密码</label>
        <input type="password" id="login-password" placeholder="请输入密码" required>
      </div>
      <button onclick="login()">登录</button>
      <p class="toggle-link" onclick="toggleForm()">没有账号？点击注册</p>
    </div>
  </div>

  <script>
    // 初始化Supabase
    const supabaseUrl = 'https://nuseexvprghvrvrjgmtg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51c2VleHZwcmdodnJ2cmpnbXRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODY2ODUsImV4cCI6MjA3MDU2MjY4NX0.brOTpatidIH9YL0j6DD7L0HSsS5yn2IC54DeSIThlW8';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 切换注册/登录表单显示
    function toggleForm() {
      const regForm = document.getElementById('register-form');
      const loginForm = document.getElementById('login-form');
      regForm.style.display = regForm.style.display === 'none' ? 'block' : 'none';
      loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
    }

    // 注册功能
    async function register() {
      const nickname = document.getElementById('reg-nickname').value.trim();
      const password = document.getElementById('reg-password').value;

      if (!nickname || !password) {
        alert('请输入昵称和密码');
        return;
      }

      // 用昵称拼接唯一邮箱（自定义后缀）
      const email = `${nickname}@yourchat.com`;

      const { error } = await supabase.auth.signUp({
        email: email,
        password: password
      });

      if (error) {
        // 昵称已存在时，Supabase会提示“邮箱已被使用”，这里转换为更友好的提示
        if (error.message.includes('User already registered')) {
          alert('注册失败：该昵称已被使用');
        } else {
          alert('注册失败：' + error.message);
        }
      } else {
        alert('注册成功！请使用你的昵称和密码登录～');
        toggleForm(); // 自动切换到登录表单
      }
    }

    // 登录功能
    async function login() {
      const nickname = document.getElementById('login-nickname').value.trim();
      const password = document.getElementById('login-password').value;

      if (!nickname || !password) {
        alert('请输入昵称和密码');
        return;
      }

      const email = `${nickname}@yourchat.com`;

      const { error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (error) {
        // 密码错误或昵称不存在的提示转换
        if (error.message.includes('Invalid login credentials')) {
          alert('登录失败：昵称或密码错误');
        } else {
          alert('登录失败：' + error.message);
        }
      } else {
        // 保存昵称到本地存储，跳转聊天页
        localStorage.setItem('nickname', nickname);
        window.location.href = 'chat.html';
      }
    }
  </script>
</body>
</html>
